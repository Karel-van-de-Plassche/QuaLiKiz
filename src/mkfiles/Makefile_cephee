#Makefile for the cephee cluster

include archfiles/arch_cephee.inc

# Directory for math routines
ROUT = mathlib

# Directory for math routines
CUB = cubpack

# Fortran files for QUALIKIZ
OBJS_QUALIKIZ_AUX = kind.o mod_io_management.o datmat.o datcal.o dispfuncs.o asymmetry.o mod_make_io.o \
FLRterms.o mod_fluidsol.o mod_contour.o trapints.o passints.o calltrapints.o callpassints.o \
mod_fonct.o callpassQLints.o calltrapQLints.o QLflux.o nanfilter.o calcroutines.o mod_saturation.o qualikiz.o \

OBJS_MAKEFLUX = kind.o mod_io_management.o datmat.o datcal.o asymmetry.o mod_saturation.o

# Parallel or serial compilation
ifeq ($(MPI),-DMPI)
      OBJS_QUALIKIZ = $(OBJS_QUALIKIZ_AUX)
else
      OBJS_QUALIKIZ = $(OBJS_QUALIKIZ_AUX) mpivoid.o
endif

all: $(CUB)/libcubpack.a $(ROUT)/librout.a QuaLiKiz.exe
# qlk_makeflux.exe qlk_redoQL.exe

#qlk_redoQL.exe: qlk_redoQL.f90 $(OBJS_MAKEFLUX) $(ROUT)/librout.a
#	$(FC) -o qlk_redoQL.exe qlk_redoQL.f90 $(OBJS_QUALIKIZ) ${QFLAGS} ${OPENMP} $(MPI) -L$(ROUT) -lrout -L$(CUB) -lcubpack 

#qlk_makeflux.exe: qlk_makeflux.f90 $(OBJS_MAKEFLUX) $(ROUT)/librout.a
#	$(FC) -o qlk_makeflux.exe qlk_makeflux.f90 $(OBJS_QUALIKIZ) ${QFLAGS} ${OPENMP} $(MPI) -L$(ROUT) -lrout -L$(CUB) -lcubpack 

QuaLiKiz.exe: qlk_standalone.f90 qualikiz.f90 $(OBJS_QUALIKIZ) $(ROUT)/librout.a $(CUB)/libcubpack.a
	$(FC) -o QuaLiKiz.exe qlk_standalone.f90 $(OBJS_QUALIKIZ) ${QFLAGS} ${OPENMP} $(MPI) -L$(ROUT) -lrout -L$(CUB) -lcubpack 

%.o:%.f90
	$(FC) ${QFLAGS} $(MPI) $(OPENMP) -c $<

$(ROUT)/librout.a:
	cd $(ROUT);make all

$(CUB)/libcubpack.a:
	cd $(CUB);make all

clean:
	rm -f *.o *.exe *.mod

cleantot:
	rm -f *.o *.exe *.mod
	cd $(ROUT); make clean
	cd $(CUB); make veryclean



